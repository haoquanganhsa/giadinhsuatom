<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia đình Sữa - Tôm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ⚠️⚠️⚠️ THAY ĐỔI CẤU HÌNH CỦA BẠN Ở ĐÂY ⚠️⚠️⚠️
        
        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://jziirrtskhbxuvnojwdz.supabase.co';  // Thay bằng Project URL của bạn
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6aWlycnRza2hieHV2bm9qd2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNzAxNjUsImV4cCI6MjA3Njg0NjE2NX0.El-GeIjoEKhVAXzl4EIS1AHqmr0tX_MdxLLpGh1UzKs';  // Thay bằng anon public key của bạn
        
        // CLOUDINARY CONFIG
        const CLOUDINARY_CLOUD_NAME = 'dwccf5fog';  // Thay bằng Cloud name của bạn
        const CLOUDINARY_UPLOAD_PRESET = 'giadinhsuatom';  // Thay bằng preset name của bạn

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Icons SVG
        const icons = {
            upload: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
            x: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            image: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
            calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            cloud: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
            refresh: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
            zap: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            chevronLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>`,
            chevronRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`
        };

        class MemoryAlbum {
            constructor() {
                this.photos = [];
                this.selectedPhoto = null;
                this.selectedPhotoIndex = -1;
                this.isLoading = true;
                this.isSyncing = false;
                this.syncStatus = 'Đang kết nối...';
                this.uploadProgress = 0;
                this.init();
            }

            async init() {
                await this.loadPhotos();
                this.setupRealtimeListener();
                this.render();
            }

            setupRealtimeListener() {
                // Lắng nghe thay đổi realtime từ Supabase
                supabase
                    .channel('photos_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'photos' },
                        (payload) => {
                            console.log('Change received!', payload);
                            this.loadPhotos();
                        }
                    )
                    .subscribe();
            }

            async loadPhotos() {
                try {
                    const { data, error } = await supabase
                        .from('photos')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) throw error;

                    this.photos = data || [];
                    this.syncStatus = '✓ Đã đồng bộ';
                    this.isLoading = false;
                } catch (error) {
                    console.error('Error loading photos:', error);
                    this.syncStatus = '⚠️ Lỗi tải dữ liệu';
                    this.isLoading = false;
                }
                this.render();
            }

            async uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'memory-album');

                try {
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                        {
                            method: 'POST',
                            body: formData
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Cloudinary upload failed');
                    }

                    const data = await response.json();
                    return {
                        cloudinary_id: data.public_id,
                        cloudinary_url: data.secure_url
                    };
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    throw error;
                }
            }

            async deleteFromCloudinary(cloudinaryId) {
                // Note: Xóa ảnh từ Cloudinary cần API secret
                // Trong production, nên làm qua backend
                // Ở đây chỉ xóa record trong database
                console.log('Deleting from Cloudinary:', cloudinaryId);
            }

            async uploadPhoto(file) {
                if (!file.type.startsWith('image/')) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert(`Ảnh "${file.name}" quá lớn. Vui lòng chọn ảnh nhỏ hơn 10MB.`);
                    return;
                }

                this.isSyncing = true;
                this.uploadProgress = 0;
                this.syncStatus = 'Đang tải lên Cloudinary...';
                this.render();

                try {
                    // Upload to Cloudinary
                    this.uploadProgress = 30;
                    this.render();
                    
                    const cloudinaryData = await this.uploadToCloudinary(file);
                    
                    this.uploadProgress = 70;
                    this.syncStatus = 'Đang lưu vào Supabase...';
                    this.render();

                    // Save metadata to Supabase
                    const { data, error } = await supabase
                        .from('photos')
                        .insert([{
                            cloudinary_id: cloudinaryData.cloudinary_id,
                            cloudinary_url: cloudinaryData.cloudinary_url,
                            title: file.name.replace(/\.[^/.]+$/, ''),
                            date: new Date().toLocaleDateString('vi-VN'),
                            timestamp: Date.now()
                        }])
                        .select();

                    if (error) throw error;

                    this.uploadProgress = 100;
                    this.syncStatus = '✓ Đã tải lên thành công!';
                    
                    setTimeout(() => {
                        this.uploadProgress = 0;
                    }, 2000);

                } catch (error) {
                    console.error('Error uploading photo:', error);
                    alert('Lỗi khi tải ảnh lên. Vui lòng thử lại.');
                    this.syncStatus = '⚠️ Lỗi tải lên';
                }

                this.isSyncing = false;
                this.render();
            }

            async deletePhoto(photo) {
                if (!confirm('Bạn có chắc muốn xóa ảnh này?')) return;

                this.isSyncing = true;
                this.syncStatus = 'Đang xóa...';
                this.render();

                try {
                    // Delete from Supabase
                    const { error } = await supabase
                        .from('photos')
                        .delete()
                        .eq('id', photo.id);

                    if (error) throw error;

                    // Try to delete from Cloudinary (optional)
                    await this.deleteFromCloudinary(photo.cloudinary_id);

                    this.selectedPhoto = null;
                    this.syncStatus = '✓ Đã xóa';
                } catch (error) {
                    console.error('Error deleting photo:', error);
                    alert('Lỗi khi xóa ảnh. Vui lòng thử lại.');
                    this.syncStatus = '⚠️ Lỗi xóa';
                }

                this.isSyncing = false;
                this.render();
            }

            async updatePhotoTitle(id, newTitle) {
                try {
                    const { error } = await supabase
                        .from('photos')
                        .update({ title: newTitle })
                        .eq('id', id);

                    if (error) throw error;

                    this.syncStatus = '✓ Đã cập nhật';
                    this.render();
                } catch (error) {
                    console.error('Error updating title:', error);
                }
            }

            render() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50">
                        <!-- Header -->
                        <header class="bg-white shadow-sm sticky top-0 z-10">
                            <div class="max-w-7xl mx-auto px-4 py-6">
                                <div class="flex items-center justify-between flex-wrap gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 text-purple-600">${icons.image}</div>
                                        <div>
                                            <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                                Gia đình Sữa - Tôm
                                            </h1>
                                            <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
                                                <div class="w-4 h-4">${icons.zap}</div>
                                                <span>${this.syncStatus}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors ${this.isSyncing ? 'opacity-50' : ''}">
                                            <div class="w-5 h-5 ${this.isSyncing ? 'animate-spin' : ''}">${icons.refresh}</div>
                                            <span class="hidden sm:inline">Làm mới</span>
                                        </button>
                                        <div class="flex items-center gap-2 text-gray-600">
                                            <div class="w-5 h-5">${icons.calendar}</div>
                                            <span class="text-sm">${this.photos.length} ảnh</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main class="max-w-7xl mx-auto px-4 py-8">
                            <!-- Info Box -->
                            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg">
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 text-blue-600 flex-shrink-0">${icons.cloud}</div>
                                    <div class="text-sm text-blue-900">
                                        <strong class="block mb-1">Lưu giữ khoảnh khắc gia đình em Sữa - Tôm</strong>
                                        <ul class="space-y-1">
                                            <li>• <strong>Tải ảnh</strong> lưu giữ khoảnh khắc)</li>
                                            
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Section -->
                            <div class="mb-8">
                                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-purple-300 rounded-2xl cursor-pointer bg-white hover:bg-purple-50 transition-all duration-300 hover:border-purple-500 ${this.isSyncing ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <div class="w-12 h-12 text-purple-500 mb-3">${icons.upload}</div>
                                        <p class="mb-2 text-lg font-semibold text-gray-700">
                                            ${this.isSyncing ? 'Đang tải lên...' : 'Nhấn để tải ảnh lên'}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            PNG, JPG, GIF (tối đa 10MB mỗi ảnh)
                                        </p>
                                        ${this.uploadProgress > 0 ? `
                                            <div class="w-64 mt-4">
                                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: ${this.uploadProgress}%"></div>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1 text-center">${this.uploadProgress}%</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <input
                                        type="file"
                                        id="fileInput"
                                        class="hidden"
                                        accept="image/*"
                                        multiple
                                        ${this.isSyncing ? 'disabled' : ''}
                                    />
                                </label>
                            </div>

                            <!-- Photos Grid -->
                            ${this.isLoading ? `
                                <div class="text-center py-16">
                                    <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-gray-500 text-lg">Đang tải ảnh từ Cloudinary...</p>
                                </div>
                            ` : this.photos.length === 0 ? `
                                <div class="text-center py-16">
                                    <div class="w-24 h-24 text-gray-300 mx-auto mb-4">${icons.image}</div>
                                    <p class="text-gray-500 text-lg">
                                        Chưa có ảnh nào. Hãy tải ảnh đầu tiên lên!
                                    </p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                                    ${this.photos.map(photo => `
                                        <div class="group relative bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:scale-105"
                                             onclick="app.selectPhoto('${photo.id}')">
                                            <div class="aspect-square overflow-hidden bg-gray-100">
                                                <img
                                                    src="${photo.cloudinary_url.replace('/upload/', '/upload/w_300,h_300,c_fill,q_auto,f_auto/')}"
                                                    alt="${photo.title}"
                                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                                    loading="lazy"
                                                />
                                            </div>
                                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-300"></div>
                                            <button
                                                onclick="event.stopPropagation(); app.deletePhotoById('${photo.id}')"
                                                class="absolute top-1 right-1 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hover:bg-red-600 z-10"
                                            >
                                                <div class="w-3 h-3">${icons.x}</div>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </main>

                        <!-- Photo Modal -->
                        ${this.selectedPhoto ? `
                            <div class="fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4"
                                 onclick="app.closeModal()">
                                <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
                                    
                                    <!-- Close Button -->
                                    <button
                                        onclick="app.closeModal()"
                                        class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors bg-black bg-opacity-50 rounded-full p-2 z-50"
                                    >
                                        <div class="w-6 h-6">${icons.x}</div>
                                    </button>

                                    <!-- Previous Button -->
                                    ${this.selectedPhotoIndex > 0 ? `
                                        <button
                                            onclick="app.prevPhoto()"
                                            class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-all bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-3 z-50"
                                        >
                                            <div class="w-8 h-8">${icons.chevronLeft}</div>
                                        </button>
                                    ` : ''}

                                    <!-- Next Button -->
                                    ${this.selectedPhotoIndex < this.photos.length - 1 ? `
                                        <button
                                            onclick="app.nextPhoto()"
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-all bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-3 z-50"
                                        >
                                            <div class="w-8 h-8">${icons.chevronRight}</div>
                                        </button>
                                    ` : ''}

                                    <!-- Image Container -->
                                    <div class="flex flex-col items-center max-w-7xl max-h-full">
                                        <img
                                            src="${this.selectedPhoto.cloudinary_url.replace('/upload/', '/upload/q_auto,f_auto/')}"
                                            alt="${this.selectedPhoto.title}"
                                            class="max-w-full max-h-[75vh] object-contain rounded-lg shadow-2xl"
                                        />
                                        
                                        <!-- Photo Info -->
                                        <div class="mt-4 bg-white rounded-lg p-4 max-w-2xl w-full">
                                            <div class="flex items-start justify-between gap-4">
                                                <div class="flex-1">
                                                    <input
                                                        type="text"
                                                        id="photoTitle"
                                                        value="${this.selectedPhoto.title}"
                                                        class="w-full text-xl font-semibold border-b-2 border-transparent focus:border-purple-500 outline-none px-2 py-1 mb-2"
                                                    />
                                                    <div class="flex items-center gap-4 text-sm text-gray-500 px-2">
                                                        <span>${this.selectedPhoto.date}</span>
                                                        <span>•</span>
                                                        <span>${this.selectedPhotoIndex + 1} / ${this.photos.length}</span>
                                                    </div>
                                                </div>
                                                <button
                                                    onclick="app.deletePhotoById('${this.selectedPhoto.id}')"
                                                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
                                                >
                                                    Xóa
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                this.attachEventListeners();
            }

            attachEventListeners() {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', async (e) => {
                        const files = Array.from(e.target.files);
                        for (const file of files) {
                            await this.uploadPhoto(file);
                        }
                        e.target.value = '';
                    });
                }

                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadPhotos());
                }

                const photoTitle = document.getElementById('photoTitle');
                if (photoTitle && this.selectedPhoto) {
                    photoTitle.addEventListener('change', (e) => {
                        this.updatePhotoTitle(this.selectedPhoto.id, e.target.value);
                    });
                }

                // Keyboard navigation
                if (this.selectedPhoto) {
                    document.addEventListener('keydown', this.handleKeyPress.bind(this));
                }
            }

            handleKeyPress(e) {
                if (!this.selectedPhoto) return;
                
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    this.prevPhoto();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    this.nextPhoto();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    this.closeModal();
                }
            }

            selectPhoto(id) {
                this.selectedPhoto = this.photos.find(p => p.id === id);
                this.selectedPhotoIndex = this.photos.findIndex(p => p.id === id);
                this.render();
            }

            closeModal() {
                this.selectedPhoto = null;
                this.selectedPhotoIndex = -1;
                this.render();
            }

            nextPhoto() {
                if (this.selectedPhotoIndex < this.photos.length - 1) {
                    this.selectedPhotoIndex++;
                    this.selectedPhoto = this.photos[this.selectedPhotoIndex];
                    this.render();
                }
            }

            prevPhoto() {
                if (this.selectedPhotoIndex > 0) {
                    this.selectedPhotoIndex--;
                    this.selectedPhoto = this.photos[this.selectedPhotoIndex];
                    this.render();
                }
            }

            deletePhotoById(id) {
                const photo = this.photos.find(p => p.id === id);
                if (photo) {
                    this.deletePhoto(photo);
                }
            }
        }

        // Initialize app
        const app = new MemoryAlbum();
    </script>
</body>
</html>