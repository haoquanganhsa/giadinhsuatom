<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album K·ª∑ Ni·ªám</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è THAY ƒê·ªîI C·∫§U H√åNH C·ª¶A B·∫†N ·ªû ƒê√ÇY ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        
        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://jziirrtskhbxuvnojwdz.supabase.co';  // Thay b·∫±ng Project URL c·ªßa b·∫°n
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6aWlycnRza2hieHV2bm9qd2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNzAxNjUsImV4cCI6MjA3Njg0NjE2NX0.El-GeIjoEKhVAXzl4EIS1AHqmr0tX_MdxLLpGh1UzKs';  // Thay b·∫±ng anon public key c·ªßa b·∫°n
        
        // CLOUDINARY CONFIG
        const CLOUDINARY_CLOUD_NAME = 'dwccf5fog';  // Thay b·∫±ng Cloud name c·ªßa b·∫°n
        const CLOUDINARY_UPLOAD_PRESET = 'giadinhsuatom';  // Thay b·∫±ng preset name c·ªßa b·∫°n

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Icons SVG
        const icons = {
            upload: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
            x: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            image: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
            calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            cloud: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
            refresh: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
            zap: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`
        };

        class MemoryAlbum {
            constructor() {
                this.photos = [];
                this.selectedPhoto = null;
                this.isLoading = true;
                this.isSyncing = false;
                this.syncStatus = 'ƒêang k·∫øt n·ªëi...';
                this.uploadProgress = 0;
                this.init();
            }

            async init() {
                await this.loadPhotos();
                this.setupRealtimeListener();
                this.render();
            }

            setupRealtimeListener() {
                // L·∫Øng nghe thay ƒë·ªïi realtime t·ª´ Supabase
                supabase
                    .channel('photos_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'photos' },
                        (payload) => {
                            console.log('Change received!', payload);
                            this.loadPhotos();
                        }
                    )
                    .subscribe();
            }

            async loadPhotos() {
                try {
                    const { data, error } = await supabase
                        .from('photos')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) throw error;

                    this.photos = data || [];
                    this.syncStatus = '‚úì ƒê√£ ƒë·ªìng b·ªô';
                    this.isLoading = false;
                } catch (error) {
                    console.error('Error loading photos:', error);
                    this.syncStatus = '‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu';
                    this.isLoading = false;
                }
                this.render();
            }

            async uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'memory-album');

                try {
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                        {
                            method: 'POST',
                            body: formData
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Cloudinary upload failed');
                    }

                    const data = await response.json();
                    return {
                        cloudinary_id: data.public_id,
                        cloudinary_url: data.secure_url.replace('/upload/', '/upload/q_auto,f_auto/')
                    };
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    throw error;
                }
            }

            async deleteFromCloudinary(cloudinaryId) {
                // Note: X√≥a ·∫£nh t·ª´ Cloudinary c·∫ßn API secret
                // Trong production, n√™n l√†m qua backend
                // ·ªû ƒë√¢y ch·ªâ x√≥a record trong database
                console.log('Deleting from Cloudinary:', cloudinaryId);
            }

            async uploadPhoto(file) {
                if (!file.type.startsWith('image/')) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert(`·∫¢nh "${file.name}" qu√° l·ªõn. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 10MB.`);
                    return;
                }

                this.isSyncing = true;
                this.uploadProgress = 0;
                this.syncStatus = 'ƒêang t·∫£i l√™n Cloudinary...';
                this.render();

                try {
                    // Upload to Cloudinary
                    this.uploadProgress = 30;
                    this.render();
                    
                    const cloudinaryData = await this.uploadToCloudinary(file);
                    
                    this.uploadProgress = 70;
                    this.syncStatus = 'ƒêang l∆∞u v√†o Supabase...';
                    this.render();

                    // Save metadata to Supabase
                    const { data, error } = await supabase
                        .from('photos')
                        .insert([{
                            cloudinary_id: cloudinaryData.cloudinary_id,
                            cloudinary_url: cloudinaryData.cloudinary_url,
                            title: file.name.replace(/\.[^/.]+$/, ''),
                            date: new Date().toLocaleDateString('vi-VN'),
                            timestamp: Date.now()
                        }])
                        .select();

                    if (error) throw error;

                    this.uploadProgress = 100;
                    this.syncStatus = '‚úì ƒê√£ t·∫£i l√™n th√†nh c√¥ng!';
                    
                    setTimeout(() => {
                        this.uploadProgress = 0;
                    }, 2000);

                } catch (error) {
                    console.error('Error uploading photo:', error);
                    alert('L·ªói khi t·∫£i ·∫£nh l√™n. Vui l√≤ng th·ª≠ l·∫°i.');
                    this.syncStatus = '‚ö†Ô∏è L·ªói t·∫£i l√™n';
                }

                this.isSyncing = false;
                this.render();
            }

            async deletePhoto(photo) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?')) return;

                this.isSyncing = true;
                this.syncStatus = 'ƒêang x√≥a...';
                this.render();

                try {
                    // Delete from Supabase
                    const { error } = await supabase
                        .from('photos')
                        .delete()
                        .eq('id', photo.id);

                    if (error) throw error;

                    // Try to delete from Cloudinary (optional)
                    await this.deleteFromCloudinary(photo.cloudinary_id);

                    this.selectedPhoto = null;
                    this.syncStatus = '‚úì ƒê√£ x√≥a';
                } catch (error) {
                    console.error('Error deleting photo:', error);
                    alert('L·ªói khi x√≥a ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
                    this.syncStatus = '‚ö†Ô∏è L·ªói x√≥a';
                }

                this.isSyncing = false;
                this.render();
            }

            async updatePhotoTitle(id, newTitle) {
                try {
                    const { error } = await supabase
                        .from('photos')
                        .update({ title: newTitle })
                        .eq('id', id);

                    if (error) throw error;

                    this.syncStatus = '‚úì ƒê√£ c·∫≠p nh·∫≠t';
                    this.render();
                } catch (error) {
                    console.error('Error updating title:', error);
                }
            }

            render() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50">
                        <!-- Header -->
                        <header class="bg-white shadow-sm sticky top-0 z-10">
                            <div class="max-w-7xl mx-auto px-4 py-6">
                                <div class="flex items-center justify-between flex-wrap gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 text-purple-600">${icons.image}</div>
                                        <div>
                                            <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                                Album K·ª∑ Ni·ªám
                                            </h1>
                                            <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
                                                <div class="w-4 h-4">${icons.zap}</div>
                                                <span>${this.syncStatus}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors ${this.isSyncing ? 'opacity-50' : ''}">
                                            <div class="w-5 h-5 ${this.isSyncing ? 'animate-spin' : ''}">${icons.refresh}</div>
                                            <span class="hidden sm:inline">L√†m m·ªõi</span>
                                        </button>
                                        <div class="flex items-center gap-2 text-gray-600">
                                            <div class="w-5 h-5">${icons.calendar}</div>
                                            <span class="text-sm">${this.photos.length} ·∫£nh</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main class="max-w-7xl mx-auto px-4 py-8">
                            <!-- Info Box -->
                            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg">
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 text-blue-600 flex-shrink-0">${icons.cloud}</div>
                                    <div class="text-sm text-blue-900">
                                        <strong class="block mb-1">üöÄ Cloudinary + Supabase Stack:</strong>
                                        <ul class="space-y-1">
                                            <li>‚Ä¢ <strong>25GB</strong> storage mi·ªÖn ph√≠ (Cloudinary)</li>
                                            <li>‚Ä¢ <strong>Realtime sync</strong> ƒëa thi·∫øt b·ªã (Supabase)</li>
                                            <li>‚Ä¢ <strong>CDN to√†n c·∫ßu</strong> - t·∫£i ·∫£nh si√™u nhanh</li>
                                            <li>‚Ä¢ <strong>100% mi·ªÖn ph√≠</strong> - kh√¥ng c·∫ßn th·∫ª t√≠n d·ª•ng!</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Section -->
                            <div class="mb-8">
                                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-purple-300 rounded-2xl cursor-pointer bg-white hover:bg-purple-50 transition-all duration-300 hover:border-purple-500 ${this.isSyncing ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <div class="w-12 h-12 text-purple-500 mb-3">${icons.upload}</div>
                                        <p class="mb-2 text-lg font-semibold text-gray-700">
                                            ${this.isSyncing ? 'ƒêang t·∫£i l√™n...' : 'Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n'}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            PNG, JPG, GIF (t·ªëi ƒëa 10MB m·ªói ·∫£nh)
                                        </p>
                                        ${this.uploadProgress > 0 ? `
                                            <div class="w-64 mt-4">
                                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: ${this.uploadProgress}%"></div>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1 text-center">${this.uploadProgress}%</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <input
                                        type="file"
                                        id="fileInput"
                                        class="hidden"
                                        accept="image/*"
                                        multiple
                                        ${this.isSyncing ? 'disabled' : ''}
                                    />
                                </label>
                            </div>

                            <!-- Photos Grid -->
                            ${this.isLoading ? `
                                <div class="text-center py-16">
                                    <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-gray-500 text-lg">ƒêang t·∫£i ·∫£nh t·ª´ Cloudinary...</p>
                                </div>
                            ` : this.photos.length === 0 ? `
                                <div class="text-center py-16">
                                    <div class="w-24 h-24 text-gray-300 mx-auto mb-4">${icons.image}</div>
                                    <p class="text-gray-500 text-lg">
                                        Ch∆∞a c√≥ ·∫£nh n√†o. H√£y t·∫£i ·∫£nh ƒë·∫ßu ti√™n l√™n!
                                    </p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                    ${this.photos.map(photo => `
                                        <div class="group relative bg-white rounded-xl shadow-md overflow-hidden hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1"
                                             onclick="app.selectPhoto('${photo.id}')">
                                            <div class="aspect-square overflow-hidden bg-gray-100">
                                                <img
                                                    src="${photo.cloudinary_url.replace('/upload/', '/upload/w_400,h_400,c_fill/')}"
                                                    alt="${photo.title}"
                                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                                    loading="lazy"
                                                />
                                            </div>
                                            <div class="p-4">
                                                <p class="font-semibold text-gray-800 truncate">
                                                    ${photo.title}
                                                </p>
                                                <p class="text-sm text-gray-500 mt-1">${photo.date}</p>
                                            </div>
                                            <button
                                                onclick="event.stopPropagation(); app.deletePhotoById('${photo.id}')"
                                                class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 hover:bg-red-600"
                                            >
                                                <div class="w-4 h-4">${icons.x}</div>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </main>

                        <!-- Photo Modal -->
                        ${this.selectedPhoto ? `
                            <div class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
                                 onclick="app.closeModal()">
                                <div class="relative max-w-5xl max-h-full" onclick="event.stopPropagation()">
                                    <button
                                        onclick="app.closeModal()"
                                        class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors"
                                    >
                                        <div class="w-8 h-8">${icons.x}</div>
                                    </button>
                                    <img
                                        src="${this.selectedPhoto.cloudinary_url}"
                                        alt="${this.selectedPhoto.title}"
                                        class="max-w-full max-h-[80vh] object-contain rounded-lg"
                                    />
                                    <div class="mt-4 bg-white rounded-lg p-4">
                                        <input
                                            type="text"
                                            id="photoTitle"
                                            value="${this.selectedPhoto.title}"
                                            class="w-full text-xl font-semibold border-b-2 border-transparent focus:border-purple-500 outline-none px-2 py-1"
                                        />
                                        <p class="text-gray-500 mt-2 px-2">${this.selectedPhoto.date}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                this.attachEventListeners();
            }

            attachEventListeners() {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', async (e) => {
                        const files = Array.from(e.target.files);
                        for (const file of files) {
                            await this.uploadPhoto(file);
                        }
                        e.target.value = '';
                    });
                }

                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadPhotos());
                }

                const photoTitle = document.getElementById('photoTitle');
                if (photoTitle && this.selectedPhoto) {
                    photoTitle.addEventListener('change', (e) => {
                        this.updatePhotoTitle(this.selectedPhoto.id, e.target.value);
                    });
                }
            }

            selectPhoto(id) {
                this.selectedPhoto = this.photos.find(p => p.id === id);
                this.render();
            }

            closeModal() {
                this.selectedPhoto = null;
                this.render();
            }

            deletePhotoById(id) {
                const photo = this.photos.find(p => p.id === id);
                if (photo) {
                    this.deletePhoto(photo);
                }
            }
        }

        // Initialize app
        const app = new MemoryAlbum();
    </script>
</body>
</html>